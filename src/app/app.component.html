<div class="app-container" cdkDropListGroup>

  <!-- Left Main Chart Area (75%) -->
  <div class="main-chart" #mainChart>
    <div class="levels-container" #levelsContainer>
      <!-- SVG Connector Layer -->
      <svg class="connector-layer">
          <path *ngFor="let c of connectors()" [attr.d]="c.d" />
      </svg>
      
      <div *ngFor="let levelIndex of levels()" class="level-row">
        <div class="level-label">Level {{ levelIndex + 1 }}</div>
        
        <div
          cdkDropList
          [cdkDropListData]="getNodesForLevel(levelIndex)"
          [id]="'level-' + levelIndex"
          class="level-list"
          (cdkDropListDropped)="drop($event)">
          
          <!-- Level 1 (Index 0): Render directly as they have no parents in the chart -->
          <ng-container *ngIf="levelIndex === 0">
              <div *ngFor="let node of getNodesForLevel(0)" cdkDrag [cdkDragData]="node" [cdkDragDisabled]="!isEditMode()" class="node-card" [id]="'node-' + node.id">
                 <div class="node-content">
                   <div class="node-header">
                       <div class="node-name">{{ node.name }}</div>
                       <div class="node-title">{{ getParentName(node) }}</div>
                       <button *ngIf="isEditMode()" mat-icon-button color="warn" class="delete-btn" (click)="deleteNode(node)">
                           <mat-icon>close</mat-icon>
                       </button>
                   </div>
                 </div>
              </div>
          </ng-container>

          <!-- Level > 1: Group by Parent from Previous Level -->
          <ng-container *ngIf="levelIndex > 0">
             <div *ngFor="let parent of getNodesForLevel(levelIndex - 1)" class="parent-group">
                <!-- Iterate children of this parent -->
                <ng-container *ngFor="let node of (childrenByParent().get(parent.id) || [])">
                    <div cdkDrag [cdkDragData]="node" [cdkDragDisabled]="!isEditMode()" class="node-card" [id]="'node-' + node.id">
                        <div class="node-content">
                        <div class="node-header">
                            <div class="node-name">{{ node.name }}</div>
                            <div class="node-title">{{ getParentName(node) }}</div>
                            <button *ngIf="isEditMode()" mat-icon-button color="warn" class="delete-btn" (click)="deleteNode(node)">
                                <mat-icon>close</mat-icon>
                            </button>
                        </div>
                        </div>
                    </div>
                </ng-container>
             </div>
          </ng-container>

          <!-- Placeholder for dropping into empty space (handled by CDK list generally) -->
          
        </div>
      </div>
    </div>
    <div class="action-bar">
        <ng-container *ngIf="!isEditMode(); else editControls">
            <button mat-raised-button color="primary" (click)="toggleEditMode()">
                Edit
            </button>
        </ng-container>
        
        <ng-template #editControls>
            <div class="edit-controls">
                <button mat-raised-button color="accent" (click)="addLevel()">
                    Add +
                </button>
                <button mat-raised-button color="primary" (click)="onSave()">
                    Save
                </button>
            </div>
        </ng-template>
    </div>
    
  </div>

  <!-- Right Sidebar (25%) -->
  <div class="sidebar">
    <div class="header">
      <h2>Available Positions</h2>
      <button *ngIf="isEditMode()" mat-fab color="primary" class="create-fab" (click)="openCreateDialog()">
        <mat-icon>add</mat-icon>
      </button>
  </div>
    
    <div
      cdkDropList
      [cdkDropListData]="availableNodes"
      id="available-list"
      class="available-list"
      (cdkDropListDropped)="drop($event)">
      
      <div *ngFor="let node of availableNodes" cdkDrag [cdkDragData]="node" [cdkDragDisabled]="!isEditMode()" class="node-card" [id]="'node-' + node.id">
        <div class="node-content">
          <div class="node-header">
               <div class="node-name">{{ node.name }}</div>
               <div class="node-title">{{ getParentName(node) }}</div>
               <button *ngIf="isEditMode()" mat-icon-button color="warn" class="delete-btn" (click)="deleteNode(node)">
                   <mat-icon>close</mat-icon>
               </button>
           </div>
        </div>
      </div>
      
    </div>
  </div>

</div>
